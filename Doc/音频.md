
# 音视频开发库

- iOS: AVFoundation, AudioUnit
- Android: MediaPlayer, MediaCodec
- Windows: DirectShow
- 跨平台: FFmpeg, 掌握 FFmpeg 会很快上手其他音视频开发库.


# 音频

录音的原理可以简单的理解为: 把声源的振动记录下来, 需要时再让某个物体按照记录下来的振动规律去振动, 就会产生与原来一样的声音.

## 音频数字化

如何把声音(声源的振动)记录下来? 声音属于`模拟信号`, 但更便于计算机处理和存储的是`数字信号`(二进制编码), 所以需要将 `模拟信号 (Analog Signal)` 转场 `数字信号 (Digital Signal)` 后进行存储.

这一过程, 就是: `音频数字化`.

### 脉冲编码调制 (PCM)

PCM (Pulse Code Moduration).

主要过程是:

- 采样
- 量化
- 编码

#### 1. 采样

模拟信号, 无限光滑连续, 任意时刻都有值, 所以将所有模拟信号都存储下来, 太大了, 不现实. 所以要 `采样`.

- 每隔一段时间采集一次模拟信号的样本
- 是一个在时间上将模拟信号离散化(把连续信号转换成离散信号)的过程.

##### 1.1 采样率

`每秒`采集的样本数量, 称为`采样率`(采样频率, 采样速率, Sampling Rate).

- 比如, 采样率 `44.1 kHz` 表示 `1 秒钟`采集 `44100` 个样本.

##### 1.2 采样定理

根据`采样定理` (奈奎斯特-香浓采样定理)得知: `只有当采样率高于声音信号最高频率的 2 倍时, 才能把采集的声音信号唯一地还原成原来的声音`.

- 人耳能够感觉到的最高声音频率是 `20000Hz`.
- 为满足人耳需求, 需要至少每秒进行 `40000`次采样(40Hz 采样率).
- 这就是为什么常见的 CD 的采样率为 44.1 kHz, 而电话、无线对讲机、无限麦克风等的采样率是 8kHz.

#### 2. 量化

`量化` (Quantization): 将每一个采样点的样本值数字化.

##### 2.1 位深度

`位深度`(采样精度, 采用大小, Bit Depth): 使用多少个`二进制位`来存储`一个`采样点的样本值.

- 位深度越高, 表示的振幅越精确.
- 常见的 CD 采用 `16bit` 的位深度, 能表示 `65536 (2^16)` 个不同的值.
- DVD 使用 `24bit` 的位深度, 大多数电话设备使用 `8bit` 的位深度.

> 通俗解释: 
> 用一个表格表示采样率和位深度, 那么 `采样率` 是 `竖线`. 每采集一次, 多一条竖线, 采样率越大, 则对比采样率低的, 竖线则越密(因为采集的多, 表示的就多).
> `位深度` 则是 `横线`. 如 `16 位量化`, 则有 `16 条`横线, 如`8位量化`, 则有`8 条`横线. 量化大的则会比量化小的`密`, 因为量化大的即位深度大的表示的信息多. 小的则不够精确.


#### 3. 编码

`编码`: 将采样和量化后的数字数据, 转成二进制码流.

#### 4. 其他概念

##### 4.1 声道 (Channel)

- 单声道
- 双声道

单声道产生的一组声波数据, 双声道(立体声)产生两组声波数据.

**假设采样率 44.1 kHz, 位深度 16bit, 1 分钟立体声的 PCM 数据有多大?**

- 数据大小 = 采样率 * 位深度 * 声道数 * 时间

```c
// 1s 钟采集 44100 个样本.
// 每个样本占 16 位(bit)
// 立体声有 2 个声道, 乘以 2
// 1 字节(byte) = 8 位(bit)
// kb, MB 转化
44100 * 16 * 2 * 60 / 8 ≈ 10.34 MB
```

所以如果 4 分钟的歌, 那么就会有 40 多 MB. 所以在不改变音频时长的前提下, 降低音频数据的大小, 只有 2 种方法:

- 降低采样指标.
- 压缩

降低采样指标是不可取的, 会导致音频质量下降, 用户体验变差, 因此专家们研发了各种压缩方案.

##### 4.2 比特率

`比特率` (Bit Rate), _指单位时间内传输或处理的比特数量_, 单位是: 比特每秒(bit/s或 bps). 还有 千比特秒(kbps), 兆比特秒(Mbps), 吉比特秒(Gbps), 太比特秒(Tbits).

**采样率 44.1 kHz, 位深度 16bit 的立体声 PCM 数据的比特率是多少?**

- 比特率 = 采样率 * 位深度 * 声道数

```c
44100 * 16 * 2 = 1411.2 kbps
```

通常, 采样率、位深度越高, 数字化音频的质量越好. 从比特率的计算公式可以看出: 比特率越高, 数字化音频的质量就越好.

##### 4.3 信噪比

`信噪比` , 指信号与噪声的比例, 用来比较所需信号的强度与背景噪声的强度, 以分贝 (dB)为单位.

### 音频的编码与解码

#### 编码 (Encode)

PCM 数据可以理解为是: `未经压缩的原始音频数据,` 体积比较大, 为了方便存储和传输, 一般都会使用某种 `音频编码` 对它进行编码压缩, 然后再存储成某种 `音频文件格式`.

`PCM 数据` --`音频编码(Encode)`--> `压缩数据` ----> `音频文件格式`

#### 解码 (Decode)

需要播放音频时, 得先解码(解压缩) 出 `PCM` 数据, 然后再进行播放.

`音频文件格式` ---> `压缩数据` ---音频解码(Decode)----> `PCM 数据`

#### 压缩

- 无损压缩
    - 解压后`可以`完全还原出原始数据
    - 压缩比`小`, 体积`大` 
- 有损压缩
    - 解压后`不能`完全还原出原始数据, 会丢失一部分信息
    - 压缩比`大`, 体积`小`
    - 压缩比越大, 丢失的信息越多, 还原后的信号失真就会越大
    - 一般是通过`舍弃原始数据中对人类听觉不重要的部分`, 达成压缩成较小文件的目的.
- 压缩比 = 未压缩大小 / 压缩后大小

#### 常见的音频编码和文件格式

需要注意的是: `音频文件格式`并不等于`音频编码`.如:

- `WAV` 只是一种`文件格式`, 不是一种编码.
- `FLAC` 既是一种文件格式, 又是一种编码.

##### 无损压缩

- Monkey's Audio
    - 是一种`无损`的音频编码和文件格式, 文件扩展名为`.ape`, 压缩率一般在 `55%` 左右 
- FLAC
    - 是一种`无损`的音频编码和文件格式, 文件扩展名为`.flac`, 虽然压缩率稍有不及 Monkey's Audio, 但 FLAC 技术更先进, 占用资源更低, 有更多的平台及硬件产品支持 FLAC 
- ALAC 
    - 由 Apple 开发的一种`无损`的音频编码, 文件扩展名为`.m4a`,`.caf`

##### 有损压缩

- MP3
    - 非常流行的一种`有损`音频编码和文件格式, 文件扩展名为`.mp3`.
- WMA
    - 微软开发的音频编码和文件格式, 文件扩展名为`.wma`
- AAC
    - `有损`音频编码和文件格式, 压缩比通常为 18:1
    - 文件扩展名主要有 3 种
        - `.acc`
        - `.mp4`
        - `.m4a`
- Vorbis
    - 文件拓展名 `.ogg`
- Speex
    - 文件拓展名 `.spx`
- Opus
    - 文件拓展名 `.opus`

    
##### 文件格式

- Ogg
    - 多媒体文件格式, 文件扩展名常为 `.ogg`
    - 常用的音频编码有:
        - 有损压缩: Speex, Vorbis, Opus
        - 无损压缩: FLAC
        - 未压缩: PCM  
- WAV
    - 文件扩展名 `.wav`
    - 通常采用 `PCM` 编码


WAV 文件格式:

| 大小端 | 占字节个数 | 文件名字 |
| --- | --- | --- |
| big | 4 | ChunkID |
| little | 4 | ChunkSize |
| big | 4 | Format |
| big | 4 | Subchunk1 ID |
| little | 4 | Subchunk1 Size |
| little | 2 | AudioFormat |
| little | 2 | NumChannels |
| little | 4 | SampleRate |
| little | 4 | ByteRate |
| little | 2 | BlockAlign |
| little | 2 | BitsPerSample |
| big | 4 | Subchunk2 ID |
| little | 4 | Subchunk2 Size |
| little | Subchunk2 Size | data |
 

